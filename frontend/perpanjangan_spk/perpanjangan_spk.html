<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Form Pertambahan Hari SPK</title>
    <style>
        body{font-family:Cambria,Cochin,Georgia,Times,"Times New Roman",serif;background-color:#f4f4f4;margin:0;padding:0}header{background-color:#ce1e10;color:#fff;text-align:center;padding:20px}.container{max-width:800px;margin:20px auto;background-color:#fff;padding:30px;box-shadow:0 2px 10px rgba(0,0,0,.1);border-radius:10px}.form-container{display:flex;flex-direction:column}.form-container label{font-weight:700;margin-bottom:5px;margin-top:15px}.form-container input,.form-container select,.form-container textarea{padding:10px;margin-bottom:15px;border:1px solid #ddd;border-radius:5px;font-family:Cambria}.button-group{display:flex;gap:10px;margin-top:20px}.form-container button[type=submit]{background-color:#ce1e10;color:#fff;padding:12px 20px;border:none;border-radius:5px;cursor:pointer;transition:background-color .3s;flex:1}.form-container button[type=submit]:hover{background-color:#ef190a}.input-hari-container{display:flex;align-items:center;gap:10px}.input-hari-container input{width:100px;margin-bottom:0;text-align:center}.input-hari-container span{font-weight:400}#alasan-container{display:flex;flex-direction:column;gap:10px;margin-bottom:10px}.alasan-item{display:flex;align-items:center;background-color:#f1f3f5;border:1px solid #dee2e6;padding:5px 5px 5px 15px;border-radius:25px;transition:background-color .3s}.alasan-item input{border:none;background:0 0;flex-grow:1;outline:0;margin:0;padding:5px;font-size:16px;transition:all .3s}.alasan-item input.locked{background-color:transparent;border-color:transparent;color:#212529;cursor:pointer}.alasan-item.locked-item{background-color:#e9ecef;border-color:#ced4da}.alasan-item.locked-item:hover{background-color:#dee2e6}.remove-alasan-btn{background-color:#ced4da;color:#495057;border:none;width:24px;height:24px;border-radius:50%;cursor:pointer;font-weight:700;display:flex;align-items:center;justify-content:center;margin-left:10px;transition:background-color .3s}.remove-alasan-btn:hover{background-color:#adb5bd;color:#fff}#tambah-alasan-btn{background-color:#007bff;color:#fff;padding:10px 15px;border:none;border-radius:5px;cursor:pointer;margin-top:5px;transition:background-color .3s;align-self:flex-start}#tambah-alasan-btn:hover{background-color:#0056b3}#display-container h2{color:#ce1e10;text-align:center;margin-bottom:25px}#display-container p{font-size:1.1em;line-height:1.6}#display-container ul{list-style-type:disc;padding-left:20px;margin-top:10px}#display-container li{margin-bottom:8px;font-size:1.1em}#buat-laporan-baru-btn{background-color:#28a745;color:#fff;padding:12px 20px;border:none;border-radius:5px;cursor:pointer;transition:background-color .3s;width:100%;margin-top:30px;font-size:1em}#buat-laporan-baru-btn:hover{background-color:#218838}
        .user-info { text-align: right; margin-bottom: 20px; color: #555; }
        .spinner { display: none; width: 18px; height: 18px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; vertical-align: middle; margin-right: 8px;}
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
  </head>
  <body>
    <header><h1>Form Pertambahan Hari SPK</h1></header>

    <div id="form-wrapper" class="container">
      <div class="user-info" id="userInfo"></div>
      <form id="pertambahan-spk-form" class="form-container">
        <label for="nomor_ulok">Nomor Ulok:</label>
        <input type="text" id="nomor_ulok" name="nomor_ulok" placeholder="Masukkan Nomor Ulok" required />
        <label for="pertambahan_hari">Pertambahan Hari Dari Tanggal SPK:</label>
        <div class="input-hari-container">
          <input type="number" id="pertambahan_hari" name="pertambahan_hari" min="1" max="99" oninput="this.value=this.value.slice(0,2)" placeholder="00" required />
          <span>hari</span>
        </div>
        <label for="alasan_spk">Alasan Pertambahan SPK:</label>
        <div id="alasan-container"></div>
        <button type="button" id="tambah-alasan-btn">+ Tambahkan Alasan Lainnya</button>
        <textarea name="alasan_spk" id="alasan_spk_hidden" required style="display: none"></textarea>
        <div class="button-group">
          <button type="submit" id="submitBtn"><span class="spinner" id="spinner"></span><span id="btnText">Simpan</span></button>
        </div>
      </form>
    </div>

    <div id="display-container" class="container" style="display: none;"></div>

    <script>
      // GANTI URL INI DENGAN URL WEB APP ANDA SETELAH DEPLOYMENT
      const WEB_APP_URL = "URL_WEB_APP_ANDA"; 
      
      document.addEventListener("DOMContentLoaded", function () {
        // --- Cek Login ---
        const authToken = sessionStorage.getItem('authToken');
        const userDataString = sessionStorage.getItem('userData');
        if (!authToken || !userDataString) {
          alert('Sesi tidak valid. Silakan login kembali.');
          window.location.href = WEB_APP_URL; // Redirect ke halaman login
          return;
        }
        const userData = JSON.parse(userDataString);
        document.getElementById('userInfo').innerText = `Login sebagai: ${userData.nama} (${userData.cabang})`;

        const formWrapper = document.getElementById("form-wrapper");
        const displayContainer = document.getElementById("display-container");
        const alasanContainer = document.getElementById("alasan-container");
        const tambahAlasanBtn = document.getElementById("tambah-alasan-btn");
        const hiddenTextarea = document.getElementById("alasan_spk_hidden");
        const form = document.getElementById("pertambahan-spk-form");
        const submitBtn = document.getElementById('submitBtn');
        const spinner = document.getElementById('spinner');
        const btnText = document.getElementById('btnText');

        // [PASTE SEMUA FUNGSI JAVASCRIPT LAMA ANDA DI SINI, KECUALI 'form.addEventListener']
        const createAlasanItem=()=>{const e=document.createElement("div");e.className="alasan-item",e.innerHTML=`\n          <input type="text" placeholder="Tuliskan satu alasan di sini..." />\n          <button type="button" class="remove-alasan-btn">&times;</button>\n        `,alasanContainer.appendChild(e),e.querySelector("input").focus()},updateHiddenTextarea=()=>{const e=alasanContainer.querySelectorAll(".alasan-item input"),t=[];e.forEach(e=>{""!==e.value.trim()&&t.push(`- ${e.value.trim()}`)}),hiddenTextarea.value=t.join("\n")};createAlasanItem(),tambahAlasanBtn.addEventListener("click",()=>{const e=alasanContainer.lastElementChild;e&&("_self"===(e.querySelector("input")?.value.trim()||"")?(alert("Harap isi alasan saat ini sebelum menambahkan yang baru."),e.querySelector("input").focus()):(e.querySelector("input").readOnly=!0,e.querySelector("input").classList.add("locked"),e.classList.add("locked-item"))),createAlasanItem()}),alasanContainer.addEventListener("click",function(e){if(e.target.classList.contains("remove-alasan-btn"))e.target.closest(".alasan-item").remove(),updateHiddenTextarea();else if(e.target.classList.contains("locked")){const t=e.target;t.readOnly=!1,t.classList.remove("locked"),t.parentElement.classList.remove("locked-item"),t.focus();const a=t.value.length;t.setSelectionRange(a,a)}}),alasanContainer.addEventListener("input",updateHiddenTextarea);

        const setLoading = (isLoading) => {
            submitBtn.disabled = isLoading;
            spinner.style.display = isLoading ? "inline-block" : "none";
            btnText.textContent = isLoading ? "Menyimpan..." : "Simpan";
        };

        // --- Event Listener Baru untuk Submit Form ---
        form.addEventListener("submit", async function(e) {
          e.preventDefault();
          updateHiddenTextarea();
          if (hiddenTextarea.value.trim() === "") {
            alert("Harap isi setidaknya satu alasan pertambahan SPK.");
            if (alasanContainer.children.length === 0) createAlasanItem();
            else alasanContainer.querySelector("input").focus();
            return;
          }

          setLoading(true);

          const payload = {
            action: 'submitPerpanjangan',
            token: authToken, // Sertakan token untuk verifikasi di backend
            pembuat: userData, // Kirim data user yang login
            nomor_ulok: document.getElementById('nomor_ulok').value,
            pertambahan_hari: document.getElementById('pertambahan_hari').value,
            alasan_spk: hiddenTextarea.value
          };

          try {
            const response = await fetch(WEB_APP_URL, {
              method: 'POST',
              body: JSON.stringify(payload),
              headers: { 'Content-Type': 'application/json' }
            });
            const result = await response.json();

            if (result.status === 'success') {
                displayContainer.innerHTML = `
                  <h2>Data Berhasil Dikirim</h2>
                  <p>${result.message}</p>
                  <button type="button" id="buat-laporan-baru-btn">Buat Laporan Baru</button>
                `;
                formWrapper.style.display = 'none';
                displayContainer.style.display = 'block';

                document.getElementById('buat-laporan-baru-btn').addEventListener('click', function() {
                  // Cukup reload halaman
                  window.location.reload();
                });
            } else {
              alert(`Error: ${result.message}`);
            }

          } catch (error) {
            alert("Terjadi kesalahan koneksi. Gagal mengirim data.");
          } finally {
            setLoading(false);
          }
        });
      });
    </script>
  </body>
</html>